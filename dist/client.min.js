/**
 * cross-storage - Cross domain local storage
 *
 * @version   1.0.0
 * @link      https://github.com/zendesk/cross-storage
 * @author    Daniel St. Jules <danielst.jules@gmail.com>
 * @copyright Zendesk
 * @license   Apache-2.0
 */

!function(e){function o(e,t){var r;t=t||{},this._id=o._generateUUID(),this._promise=t.promise||Promise,this._frameId=t.frameId||"CrossStorageClient-"+this._id,this._origin=o._getOrigin(e),this._requests={},this._connected=!1,this._closed=!1,this._count=0,this._timeout=t.timeout||5e3,this._listener=null,this._storageListeners={},this._storageListenerCount=0,this._installListener(),(r=t.frameId?document.getElementById(t.frameId):r)&&this._poll(),r=r||this._createFrame(e),this._hub=r.contentWindow}o.frameStyle={display:"none",position:"absolute",top:"-999px",left:"-999px"},o._getOrigin=function(e){var t=document.createElement("a");return t.href=e,(((t=!t.host?window.location:t).protocol&&":"!==t.protocol?t:window.location).protocol+"//"+t.host).replace(/:80$|:443$/,"")},o._generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},o.prototype.onConnect=function(){var e=this;return this._connected?this._promise.resolve():this._closed?this._promise.reject(new Error("CrossStorageClient has closed")):(this._requests.connect||(this._requests.connect=[]),new this._promise(function(t,r){var o=setTimeout(function(){r(new Error("CrossStorageClient could not connect"))},e._timeout);e._requests.connect.push(function(e){return clearTimeout(o),e?r(e):void t()})}))},o.prototype.set=function(e,t){return this._request("set",{key:e,value:t})},o.prototype.get=function(e){var t=Array.prototype.slice.call(arguments);return this._request("get",{keys:t})},o.prototype.del=function(){var e=Array.prototype.slice.call(arguments);return this._request("del",{keys:e})},o.prototype.clear=function(){return this._request("clear")},o.prototype.getKeys=function(){return this._request("getKeys")},o.prototype.listen=function(e){this._storageListenerCount++;var t=this._id+":"+this._storageListenerCount;return this._storageListeners[t]=e,this._request("listen",{listenerId:t}).then(function(){return t})},o.prototype.unlisten=function(e){return delete this._storageListeners[e],this._request("unlisten",{listenerId:e})},o.prototype.close=function(){var e=document.getElementById(this._frameId);e&&e.parentNode.removeChild(e),window.removeEventListener?window.removeEventListener("message",this._listener,!1):window.detachEvent("onmessage",this._listener),this._connected=!1,this._closed=!0},o.prototype._installListener=function(){var n=this;this._listener=function(e){var t,r,o;if(!n._closed&&e.data&&"string"==typeof e.data&&("null"===e.origin?"file://":e.origin)===n._origin)if("cross-storage:unavailable"!==e.data){if(-1!==e.data.indexOf("cross-storage:")&&!n._connected){if(n._connected=!0,!n._requests.connect)return;for(t=0;t<n._requests.connect.length;t++)n._requests.connect[t](r);delete n._requests.connect}if("cross-storage:ready"!==e.data){try{o=JSON.parse(e.data)}catch(e){return}o.event?n._storageListeners[o.listenerId]&&n._storageListeners[o.listenerId](o.event):o.id&&n._requests[o.id]&&n._requests[o.id](o.error,o.result)}}else if(n._closed||n.close(),n._requests.connect)for(r=new Error("Closing client. Could not access localStorage in hub."),t=0;t<n._requests.connect.length;t++)n._requests.connect[t](r)},window.addEventListener?window.addEventListener("message",this._listener,!1):window.attachEvent("onmessage",this._listener)},o.prototype._poll=function(){var e=this,t="file://"===e._origin?"*":e._origin,r=setInterval(function(){return e._connected?clearInterval(r):void(e._hub&&e._hub.postMessage("cross-storage:poll",t))},1e3)},o.prototype._createFrame=function(e){var t,r=window.document.createElement("iframe");for(t in r.id=this._frameId,o.frameStyle)o.frameStyle.hasOwnProperty(t)&&(r.style[t]=o.frameStyle[t]);return window.document.body.appendChild(r),r.src=e,r},o.prototype._request=function(e,t){var s,i;return this._closed?this._promise.reject(new Error("CrossStorageClient has closed")):((i=this)._count++,s={id:this._id+":"+i._count,method:"cross-storage:"+e,params:t},new this._promise(function(r,o){var e,t,n=setTimeout(function(){i._requests[s.id]&&(delete i._requests[s.id],o(new Error("Timeout: could not perform "+s.method)))},i._timeout);i._requests[s.id]=function(e,t){if(clearTimeout(n),delete i._requests[s.id],e)return o(new Error(e));r(t)},Array.prototype.toJSON&&(e=Array.prototype.toJSON,Array.prototype.toJSON=null),t="file://"===i._origin?"*":i._origin,i._hub.postMessage(JSON.stringify(s),t),e&&(Array.prototype.toJSON=e)}))},"undefined"!=typeof module&&module.exports?module.exports=o:"undefined"!=typeof exports?exports.CrossStorageClient=o:"function"==typeof define&&define.amd?define([],function(){return o}):e.CrossStorageClient=o}(this);