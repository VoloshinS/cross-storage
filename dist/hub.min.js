/**
 * cross-storage - Cross domain local storage
 *
 * @version   1.0.0
 * @link      https://github.com/zendesk/cross-storage
 * @author    Daniel St. Jules <danielst.jules@gmail.com>
 * @copyright Zendesk
 * @license   Apache-2.0
 */

!function(e){var i={init:function(e){var t=!0;try{window.localStorage||(t=!1)}catch(e){t=!1}if(!t)try{return window.parent.postMessage("cross-storage:unavailable","*")}catch(e){return}i._permissions=e||[],i._storageListeners={},i._installListener(),window.parent.postMessage("cross-storage:ready","*")},_installListener:function(){var e=i._listener;window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)},_listener:function(e){var t,n,r,o,s="null"===e.origin?"file://":e.origin;if("cross-storage:poll"===e.data)return window.parent.postMessage("cross-storage:ready",e.origin);if("cross-storage:ready"!==e.data){try{t=JSON.parse(e.data)}catch(e){return}if(t&&"string"==typeof t.method&&(n=t.method.split("cross-storage:")[1])){if(i._permitted(s,n))try{o=i["_"+n](t.params)}catch(e){r=e.message}else r="Invalid permissions for "+n;o=JSON.stringify({id:t.id,error:r,result:o}),window.parent.postMessage(o,"file://"===s?"*":s)}}},_permitted:function(e,t){var n,r;if(!i._inArray(t="unlisten"===t?"listen":t,["get","set","listen","del","clear","getKeys","listen"]))return!1;for(n=0;n<i._permissions.length;n++)if((r=i._permissions[n]).origin instanceof RegExp&&r.allow instanceof Array&&r.origin.test(e)&&i._inArray(t,r.allow))return!0;return!1},_set:function(e){window.localStorage.setItem(e.key,e.value)},_get:function(e){for(var t,n=window.localStorage,r=[],o=0;o<e.keys.length;o++){try{t=n.getItem(e.keys[o])}catch(e){t=null}r.push(t)}return 1<r.length?r:r[0]},_listen:function(t){var e;t.listenerId in i._storageListeners||(i._storageListeners[t.listenerId]=e=function(e){e.storageArea===window.localStorage&&(e={listenerId:t.listenerId,event:{key:e.key,newValue:e.newValue,oldValue:e.oldValue,url:e.url}},window.parent.postMessage(JSON.stringify(e),"*"))},window.addEventListener?window.addEventListener("storage",e,!1):window.attachEvent("onstorage",e))},_unlisten:function(e){var t=i._storageListeners[e.listenerId];i._storageListeners[e.listenerId]=null,window.removeEventListener?window.removeEventListener("storage",t,!1):window.detachEvent("onstorage",t)},_del:function(e){for(var t=0;t<e.keys.length;t++)window.localStorage.removeItem(e.keys[t])},_clear:function(){window.localStorage.clear()},_getKeys:function(e){for(var t=[],n=window.localStorage.length,r=0;r<n;r++)t.push(window.localStorage.key(r));return t},_inArray:function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1},_now:function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()}};"undefined"!=typeof module&&module.exports?module.exports=i:"undefined"!=typeof exports?exports.CrossStorageHub=i:"function"==typeof define&&define.amd?define([],function(){return i}):e.CrossStorageHub=i}(this);